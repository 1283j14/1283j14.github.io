<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>タイピングゲーム</title>
    <style>
        .game-area {
            margin: 20px auto;
            max-width: 800px;
            padding: 20px;
        }
        #text-display {
            font-size: 1.2rem;
            line-height: 1.6;
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .correct { color: #4CAF50; }
        .wrong { color: #f44336; }
        .current { background: #ffeb3b; }
    </style>
</head>
<body>
    <div class="game-area">
        <div class="controls">
            <select id="book-select">
                <option value="random">ランダム</option>
                <option value="neko">吾輩は猫である</option>
            </select>
            <button onclick="startGame()">開始</button>
        </div>
        <div id="text-display"></div>
        <div id="stats">
            <p>正確さ: <span id="accuracy">0</span>%</p>
            <p>速度: <span id="speed">0</span>文字/分</p>
        </div>
    </div>
    <script>
        let currentText = '';
        let currentPos = 0;
        let startTime = null;

        async function fetchText() {
            const bookType = document.getElementById('book-select').value;
            const response = await fetch(`/api/text?type=${bookType}`);
            const data = await response.json();
            return data.text;
        }

        async function startGame() {
            currentText = await fetchText();
            currentPos = 0;
            startTime = Date.now();
            displayText();
            document.addEventListener('keypress', handleKeyPress);
        }

        function displayText() {
            const display = document.getElementById('text-display');
            display.innerHTML = currentText.split('').map((char, i) => `
                <span class="${i === currentPos ? 'current' : ''}">${char}</span>
            `).join('');
        }

        function handleKeyPress(e) {
            if (currentText[currentPos] === e.key) {
                document.querySelectorAll('#text-display span')[currentPos].classList.add('correct');
                currentPos++;
                if (currentPos >= currentText.length) {
                    gameComplete();
                } else {
                    displayText();
                }
            } else {
                document.querySelectorAll('#text-display span')[currentPos].classList.add('wrong');
            }
            updateStats();
        }

        function updateStats() {
            const accuracy = (currentPos / currentText.length * 100).toFixed(1);
            const time = (Date.now() - startTime) / 1000 / 60;
            const speed = (currentPos / time).toFixed(1);
            
            document.getElementById('accuracy').textContent = accuracy;
            document.getElementById('speed').textContent = speed;
        }

        function gameComplete() {
            document.removeEventListener('keypress', handleKeyPress);
            alert('完了！');
        }
    </script>
</body>
</html>
